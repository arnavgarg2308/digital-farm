<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Farm Risk Assessment - Demo</title>
<style>
  :root {
    --bg: #0b0b0c;
    --panel: #141416;
    --muted: #bfbfbf;
    --accent: #00e676;
    --danger: #ff6b6b;
    --card: #1a1a1c;
  }
  body{
    margin:0; font-family: Inter, system-ui, Arial; background: linear-gradient(180deg,#070708,#0d0d0e);
    color:#eee; -webkit-font-smoothing:antialiased;
  }
  .wrap{ max-width:980px; margin:28px auto; padding:20px; }
  header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
  h1{ margin:0; color:var(--accent); font-size:1.4rem; }
  p.lead{ margin:6px 0 0; color:var(--muted); }

  .grid{ display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
  @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }

  /* left - questions */
  .card{ background:var(--card); border-radius:12px; padding:14px; border:1px solid #222; }
  form .q{ margin-bottom:12px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.01); }
  .q h4{ margin:0 0 6px; font-size:0.95rem; color:#fff; }
  .q .opts{ display:flex; gap:10px; flex-wrap:wrap; }
  label.opt{ background:#111; padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid #222; color:var(--muted); }
  input[type="radio"], input[type="checkbox"]{ margin-right:6px; }

  .actions{ display:flex; gap:10px; margin-top:10px; }
  .btn{ background:var(--accent); color:#000; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
  .btn.secondary{ background:#2a2a2a; color:#fff; border:1px solid #333; }
  .result{ margin-top:14px; padding:12px; border-radius:10px; background:#0f0f10; border:1px solid #222; color:var(--muted); }

  /* right - profile + history */
  .side{ display:flex; flex-direction:column; gap:14px; }
  .profile { text-align:center; padding:12px; border-radius:10px; background:rgba(255,255,255,0.01); border:1px solid #222; }
  .profile img{ width:140px; height:140px; object-fit:cover; border-radius:12px; display:block; margin:8px auto; border:2px solid #222; }
  .profile input[type="file"]{ display:block; margin:10px auto; }

  .history{ padding:12px; border-radius:10px; background:rgba(255,255,255,0.01); border:1px solid #222; max-height:420px; overflow:auto; }
  .history h4{ margin:0 0 8px; color:var(--accent); }
  .history .item{ padding:8px; border-radius:8px; margin-bottom:8px; background:#090909; border:1px solid #1b1b1b; }
  .pill{ display:inline-block; padding:6px 8px; border-radius:999px; font-weight:700; font-size:0.85rem; }
  .low{ background:rgba(0,255,136,0.12); color:var(--accent); border:1px solid rgba(0,255,136,0.08); }
  .med{ background:rgba(255,200,0,0.08); color:#ffd54d; border:1px solid rgba(255,200,0,0.06); }
  .high{ background:rgba(255,80,80,0.08); color:var(--danger); border:1px solid rgba(255,80,80,0.06); }

  .smallmuted{ color:var(--muted); font-size:0.9rem; margin-top:6px; }

  footer { margin-top:18px; text-align:center; color:var(--muted); font-size:0.9rem; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Risk Assessment</h1>
      <p class="lead">Answer short questions and upload a photo â€” system returns a risk score for your farm (demo).</p>
    </div>
    <div>
      <button class="btn" onclick="saveAndClose()">Save & Close</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Questions -->
    <div>
      <div class="card">
        <form id="riskForm">
          <!-- Question 1 -->
          <div class="q" data-q="1">
            <h4>1. Do you disinfect footwear/footbaths at entry?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q1" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q1" value="0">No</label>
            </div>
            <div class="smallmuted">Footbaths reduce pathogen entry â€” important for biosecurity.</div>
          </div>

          <!-- Question 2 -->
          <div class="q" data-q="2">
            <h4>2. Is feed stored in a sealed/rodent-proof container?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q2" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q2" value="0">No</label>
            </div>
          </div>

          <!-- Question 3 -->
          <div class="q" data-q="3">
            <h4>3. Do you isolate new animals for 2+ weeks before mixing?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q3" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q3" value="0">No</label>
            </div>
          </div>

          <!-- Question 4 -->
          <div class="q" data-q="4">
            <h4>4. Are sick animals separated & treated promptly?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q4" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q4" value="0">No</label>
            </div>
          </div>

          <!-- Question 5 -->
          <div class="q" data-q="5">
            <h4>5. Is there a written vaccination schedule and records?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q5" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q5" value="0">No</label>
            </div>
          </div>

          <!-- Question 6 -->
          <div class="q" data-q="6">
            <h4>6. Do you limit visitor access and maintain visitor logs?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q6" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q6" value="0">No</label>
            </div>
          </div>

          <!-- Question 7 -->
          <div class="q" data-q="7">
            <h4>7. Do you use dedicated clothing/boots for farm work?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q7" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q7" value="0">No</label>
            </div>
          </div>

          <!-- Question 8 -->
          <div class="q" data-q="8">
            <h4>8. Do you have regular pest control (rodents, insects)?</h4>
            <div class="opts">
              <label class="opt"><input type="radio" name="q8" value="1">Yes</label>
              <label class="opt"><input type="radio" name="q8" value="0">No</label>
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn" onclick="calculateRisk()">Calculate Risk</button>
            <button type="button" class="btn secondary" onclick="clearForm()">Reset</button>
          </div>

          <div id="resultBox" class="result hidden" aria-live="polite"></div>
        </form>
      </div>

      <div style="margin-top:12px;" class="card">
        <h4 style="margin-top:0;color:var(--accent)">Notes</h4>
        <p class="smallmuted">This is a demo self-assessment tool for awareness. For official classification, consult a veterinarian / authority.</p>
      </div>
    </div>

    <!-- RIGHT: Profile & history -->
    <aside class="side">
      <div class="profile card">
        <h4 style="margin:0;color:var(--accent)">Farmer Photo</h4>
        <img id="photoPreview" src="" alt="No photo" onerror="this.style.display='none'">
        <input type="file" id="photoInput" accept="image/*">
        <div class="smallmuted">Upload a photo of farm or animals (optional).</div>
      </div>

      <div class="history card">
        <h4>Assessment History</h4>
        <div id="historyList"></div>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button class="mini btn secondary" onclick="exportHistory()">Export CSV</button>
          <button class="mini btn secondary" onclick="clearHistory()">Clear History</button>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    <small>Demo Risk Assessment â€¢ Data stored locally in your browser</small>
  </footer>
</div>

<script>
  (function ensureLogin() {
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
  if (!currentUser || currentUser.role !== "farmer") {
    alert("Please login as a farmer first!");
    window.location.href = "index.html"; // redirect to login page
  }
})();
// ðŸ”¹ Returns unique key per logged-in farmer
function getUserKey() {
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
  return currentUser && currentUser.id ? `sf_assessment_history_${currentUser.id}` : null;
}

// ðŸ”¹ Get / save history
function getHistory() {
  const key = getUserKey();
  return key ? JSON.parse(localStorage.getItem(key) || "[]") : [];
}
function saveHistory(arr) {
  const key = getUserKey();
  if (key) localStorage.setItem(key, JSON.stringify(arr));
}

/* ======== Photo handling ======== */
const photoInput = document.getElementById("photoInput");
const photoPreview = document.getElementById("photoPreview");

photoInput.addEventListener("change", function () {
  const f = this.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    photoPreview.src = e.target.result;
    photoPreview.style.display = "block";
  };
  reader.readAsDataURL(f);
});

/* ======== Risk calculation ======== */
function calculateRisk() {
  const form = document.getElementById("riskForm");
  const total = 8;
  let yes = 0;
  for (let i = 1; i <= total; i++) {
    if (form["q" + i]?.value === "1") yes++;
  }
  const score = yes / total;
  const percentage = Math.round(score * 100);
  const level = score >= 0.75 ? "Low" : score >= 0.4 ? "Medium" : "High";

  // show result
  const box = document.getElementById("resultBox");
  box.classList.remove("hidden");
  box.innerHTML = `
    <strong>Score: ${percentage}%</strong>
    <div style="margin-top:8px;">Risk level:
      <span class="pill ${level === "Low" ? "low" : level === "Medium" ? "med" : "high"}">${level}</span>
    </div>
  `;

  // save assessment record globally for admin overview
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
  if (!currentUser) {
    alert("Login required");
    return;
  }
  const userId = currentUser.id;
  const allAssessments = JSON.parse(localStorage.getItem("assessments") || "[]");
  allAssessments.push({
    id: Date.now(),
    userId,
    score: percentage,
    level,
    createdAt: new Date().toISOString(),
  });
  localStorage.setItem("assessments", JSON.stringify(allAssessments));

  // save local private history (for this farmer only)
  const imgData = photoPreview.src.startsWith("data:") ? photoPreview.src : null;
  const hist = getHistory();
  hist.push({
    id: Date.now(),
    userId,
    percentage,
    level,
    yes,
    total,
    photo: imgData,
    ts: new Date().toISOString(),
  });
  saveHistory(hist);
  renderHistory();
}

/* ======== Render History (for logged-in farmer only) ======== */
function renderHistory() {
  const list = document.getElementById("historyList");
  const hist = getHistory().slice().reverse();
  if (!hist.length) {
    list.innerHTML = '<div class="smallmuted">No assessments yet.</div>';
    return;
  }
  list.innerHTML = "";
  hist.forEach((e) => {
    const d = new Date(e.ts);
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div><b>${d.toLocaleString()}</b> â€” ${e.percentage}% (${e.level})</div>
    `;
    if (e.photo) {
      const img = document.createElement("img");
      img.src = e.photo;
      img.style.width = "100%";
      img.style.borderRadius = "8px";
      img.style.marginTop = "8px";
      div.appendChild(img);
    }
    list.appendChild(div);
  });
}

/* ====== Export / Clear ====== */
function exportHistory() {
  const hist = getHistory();
  if (!hist.length) return alert("No data");
  let csv = "id,timestamp,percentage,level\n";
  hist.forEach((h) => (csv += `${h.id},${h.ts},${h.percentage},${h.level}\n`));
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "history.csv";
  a.click();
}
function clearHistory() {
  if (confirm("Clear your history?")) {
    saveHistory([]);
    renderHistory();
  }
}

/* ====== Form Reset ====== */
function clearForm() {
  document.getElementById("riskForm").reset();
  document.getElementById("resultBox").classList.add("hidden");
}
function saveAndClose() {
  alert("Assessment saved successfully!");
  window.location.href = "farmer.html";
}

/* ====== Init ====== */
document.addEventListener("DOMContentLoaded", renderHistory);
</script>
</body>
</html>