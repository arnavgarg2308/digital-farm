<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Farmer Booking Requests</title>
<style>
body{background:#0c0c0c;color:#eee;font-family:Inter,system-ui;padding:20px;}
h1{color:#00c853;}
.request{background:#161616;padding:10px;margin-bottom:10px;border-radius:8px;display:flex;gap:10px;align-items:center;}
.request img{width:70px;height:70px;object-fit:cover;border-radius:8px;}
.btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
.confirm{background:#00c853;color:#031;}
.decline{background:#e53935;color:#fff;}
</style>
</head>
<body>
<h1>üì® Booking Requests</h1>
<div id="reqBox"></div>
<div id="emptyBox" style="color:#aaa;">No requests yet.</div>

<script>
function getCurrentFarmer(){
  // example farmer login
  return JSON.parse(localStorage.getItem('currentUser_farmer') || '{"id":"demoFarmer1","name":"Demo Farmer"}');
}
function loadRequests(){
  const f = getCurrentFarmer();
  return JSON.parse(localStorage.getItem('farmerRequests_' + f.id) || '[]');
}
function saveRequests(arr){
  const f = getCurrentFarmer();
  localStorage.setItem('farmerRequests_' + f.id, JSON.stringify(arr));
}

function renderRequests(){
  const box = document.getElementById('reqBox');
  const empty = document.getElementById('emptyBox');
  const data = loadRequests();
  box.innerHTML = '';
  if (!data.length){ empty.style.display='block'; return; }
  empty.style.display='none';

  data.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className = 'request';
    div.innerHTML = `
      <img src="${r.images?.[0]||''}">
      <div style="flex:1">
        <div style="font-weight:700">${r.title}</div>
        <div style="color:#aaa;font-size:0.9rem">‚Çπ${r.price} ‚Ä¢ ${r.stock}kg</div>
        <small>Buyer: ${r.buyerName}</small><br>
        <small>Status: ${r.status}</small>
      </div>
      ${r.status==='Pending' ? `
        <button class="btn confirm" onclick="updateStatus(${i},'Confirmed')">Confirm</button>
        <button class="btn decline" onclick="updateStatus(${i},'Declined')">Decline</button>
      ` : `<span style="color:${r.status==='Confirmed'?'#00c853':'#e53935'};">${r.status}</span>`}
    `;
    box.appendChild(div);
  });
}

function updateStatus(i, status){
  const reqs = loadRequests();
  const req = reqs[i];
  req.status = status;
  saveRequests(reqs);
  renderRequests();

  // ‚úÖ When farmer confirms ‚Üí send data to buyer_payment section
  if (status === 'Confirmed') {
    const buyerOrdersKey = 'buyerOrders_' + req.buyerId;
    const existing = JSON.parse(localStorage.getItem(buyerOrdersKey) || '[]');
    const newOrder = {
      title: req.title,
      price: req.price,
      stock: req.stock,
      images: req.images,
      status: 'Pending'
    };
    existing.push(newOrder);
    localStorage.setItem(buyerOrdersKey, JSON.stringify(existing));
    alert('‚úÖ Booking Confirmed and sent to Buyer Payment Section');
  }

  // ‚ùå If declined, remove it from buyer‚Äôs side if it exists
  if (status === 'Declined') {
    const buyerOrdersKey = 'buyerOrders_' + req.buyerId;
    const existing = JSON.parse(localStorage.getItem(buyerOrdersKey) || '[]');
    const updated = existing.filter(o => o.title !== req.title);
    localStorage.setItem(buyerOrdersKey, JSON.stringify(updated));
    alert('‚ùå Booking Declined and removed from Buyer Payment Section');
  }
}

function removeRequest(i){
  if(!confirm('Remove this request?')) return;
  const reqs = loadRequests();
  reqs.splice(i,1);
  saveRequests(reqs);
  renderRequests();
}

document.addEventListener('DOMContentLoaded', renderRequests);
</script>
</body>
</html>