<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farm Risk Heatmap</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; background:#0b0b0c; color:white; }
  #map { width:100%; height:100vh; }
  .leaflet-popup-content { font-size:14px; }
</style>
</head>
<body>

<h2 style="text-align:center;margin:10px;">🌾 Farm Risk Heatmap (Live)</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([22.9734, 78.6569], 5); // India center

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Load users + assessments
const users = JSON.parse(localStorage.getItem('users') || '[]');
const assessments = JSON.parse(localStorage.getItem('assessments') || '[]');

const districtCache = {}; // Cache lat/lon for districts

// fetch district coordinates (free API)
async function getDistrictCoords(district) {
  const key = district.toLowerCase();
  if (districtCache[key]) return districtCache[key];
  try {
    const url = `https://nominatim.openstreetmap.org/search?country=India&city=${encodeURIComponent(district)}&format=json`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.length > 0) {
      const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      districtCache[key] = coords;
      return coords;
    }
  } catch (err) {
    console.error("❌ Error fetching coords for:", district, err);
  }
  return null;
}

// Color based on risk
function getColor(level) {
  if (level === 'Low') return 'green';
  if (level === 'Medium') return 'yellow';
  if (level === 'High') return 'red';
  return 'gray';
}

// Add small random offset so multiple farmers in same district show separately
function randomOffset(coord) {
  const latOffset = (Math.random() - 0.5) * 0.05;  // about ~5km variation
  const lonOffset = (Math.random() - 0.5) * 0.05;
  return [coord[0] + latOffset, coord[1] + lonOffset];
}

async function plotAll() {
  const farmers = users.filter(u => u.role === 'farmer');
  for (const user of farmers) {
    const userAssessments = assessments.filter(a =>
      a.userId === user.id || a.userId === user.email || a.userId === user.phone
    );
    if (!userAssessments.length) continue;

    const last = userAssessments[userAssessments.length - 1];
    const district = user.district;
    if (!district) continue;

    const coords = await getDistrictCoords(district);
    if (!coords) continue;

    // Slight offset for visibility
    const offsetCoords = randomOffset(coords);
    const color = getColor(last.level);

    const circle = L.circleMarker(offsetCoords, {
      radius: 9,
      fillColor: color,
      color: color,
      weight: 1,
      fillOpacity: 0.75
    }).addTo(map);

    const popup = `
      <strong>${user.farmName || 'Unknown Farm'}</strong><br>
      👨‍🌾 ${user.name}<br>
      📧 ${user.email}<br>
      📞 ${user.phone}<br>
      🗺️ District: ${district}<br>
      🌾 Risk: <b style="color:${color}">${last.level}</b> (${last.score}%)
    `;
    circle.bindPopup(popup);
  }
}

plotAll();
</script>
</body>
</html>
